#!/usr/bin/env bash

set -euo pipefail
trap 'echo "Error: Script failed at line $LINENO"; exit 1;' ERR

echo "ğŸš€ Starting AWS deployment..."

# Build Lambda functions
echo "ğŸ”¨ Building Lambda functions..."
bun run build:aws

# Initialize Terraform
echo "ğŸ—ï¸ Initializing Terraform..."
cd terraform/aws
terraform init

# Plan deployment
echo "ğŸ“‹ Planning deployment..."
doppler run -p ai-digest -c prd -- terraform plan

# Apply deployment
echo "ğŸš¢ Deploying to AWS..."
doppler run -p ai-digest -c prd -- terraform apply -auto-approve

echo "âœ… AWS deployment complete!"
echo ""
echo "ğŸ“ Next steps:"
echo "1. Update secrets in AWS Secrets Manager (see terraform output)"
echo "2. Test the API Gateway endpoint (see terraform output)"
echo "3. Monitor CloudWatch logs for function executions"