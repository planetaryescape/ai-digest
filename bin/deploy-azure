#!/usr/bin/env bash

set -euo pipefail
trap 'echo "Error: Script failed at line $LINENO"; exit 1;' ERR

echo "ğŸš€ Starting Azure deployment..."

# Build Azure Functions
echo "ğŸ”¨ Building Azure Functions..."
bun run build:azure

# Create zip package
echo "ğŸ“¦ Creating deployment package..."
bun run zip

# Initialize Terraform
echo "ğŸ—ï¸ Initializing Terraform..."
cd terraform/azure
terraform init

# Plan deployment
echo "ğŸ“‹ Planning deployment..."
terraform plan

# Apply deployment
echo "ğŸš¢ Deploying to Azure..."
terraform apply -auto-approve

echo "âœ… Azure deployment complete!"
echo ""
echo "ğŸ“ Next steps:"
echo "1. Update secrets in Key Vault (see terraform output)"
echo "2. Test the function endpoint (see terraform output)"
echo "3. Monitor Application Insights for function executions"